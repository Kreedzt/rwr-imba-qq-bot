# Feature Specification: 迁移图像渲染依赖到 skia-canvas

**Feature Branch**: `001-migrate-skia-canvas`  
**Created**: 2026-01-27  
**Status**: Draft  
**Input**: User description: "此项目由于经常遇到 github actions 的流水线安装依赖报错问题. 现在准备迁移到 skia-canvas. 目标包最新版本为 3.0.8. 细化此需求内容"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - CI 流水线依赖安装稳定 (Priority: P1)

作为项目维护者，我希望 CI（GitHub Actions）在安装依赖阶段稳定成功，从而减少因为依赖安装失败导致的流水线中断与重复重试。

**Why this priority**: 当前主要痛点来自 CI 频繁在依赖安装阶段报错，直接阻塞发布与合并；先解决稳定性才能保证后续任何功能迭代的效率。

**Independent Test**: 在不改动任何业务逻辑的前提下，仅完成依赖迁移后即可通过“重复触发 CI 并观察依赖安装阶段是否稳定成功”来验证价值。

**Acceptance Scenarios**:

1. **Given** 主分支代码未变更业务功能，**When** 触发一次完整 CI 流水线，**Then** 依赖安装阶段成功完成且流水线继续执行后续步骤
2. **Given** 以相同代码与配置重复触发多次 CI，**When** 连续运行 20 次，**Then** 依赖安装阶段失败次数不超过 1 次（≥ 95% 成功率）

---

### User Story 2 - 现有图片生成功能保持可用 (Priority: P2)

作为机器人使用者/维护者，我希望项目中所有现有的“生成图片并发送/输出”的功能在迁移后仍然能正常工作，避免出现生成失败、内容缺失或明显错乱。

**Why this priority**: 迁移的价值来自稳定性，但不能以破坏现有图片能力为代价；确保输出可用是迁移的基本门槛。

**Independent Test**: 选择一组“迁移前已有的、可重复触发的”图片生成场景（回归样例集），逐个触发并检查输出是否可用且关键信息完整。

**Acceptance Scenarios**:

1. **Given** 已定义回归样例集（至少 3 个覆盖核心图片输出的场景），**When** 在本地与 CI 环境分别执行样例集，**Then** 100% 场景都能生成图片且不报错
2. **Given** 任一图片生成场景包含文本与图形元素，**When** 生成图片，**Then** 输出图片中不出现“空白/缺字/缺图/尺寸为 0/无法打开”等明显不可用问题

---

### User Story 3 - 开发者本地安装体验改善 (Priority: P3)

作为开发者，我希望在常见开发环境中安装依赖更顺畅，减少因为底层图形依赖导致的安装失败或额外手工步骤。

**Why this priority**: 本地安装失败会放大排查成本并影响贡献者参与；但相较 CI 阻塞，优先级略低。

**Independent Test**: 在一台干净环境（无额外手工预装步骤）执行安装流程并能完成图片回归样例。

**Acceptance Scenarios**:

1. **Given** 新克隆的项目与干净依赖缓存，**When** 执行一次完整依赖安装，**Then** 安装过程无人工干预即可完成

---

### Edge Cases

- 在 CI 的不同运行环境/架构下（例如不同 Node 版本矩阵或 runner 镜像变化）是否仍能完成依赖安装？
- 当图片生成依赖的字体/图片资源缺失时，系统如何提示与降级（例如返回可读错误信息而非静默失败）？
- 高并发触发图片生成时是否会出现内存飙升、超时或进程崩溃？
- 生成超大尺寸图片或异常参数输入时是否能被限制并给出清晰错误？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 将现有图像渲染/绘图依赖迁移为 `skia-canvas`，并将目标版本锁定为 `3.0.8`
- **FR-002**: 系统 MUST 移除或禁用导致 CI 依赖安装失败的旧图像渲染依赖（包括其直接引用入口），避免在 CI 中触发同类安装错误
- **FR-003**: 系统 MUST 保持所有现有图片生成相关功能对外行为一致（同样的输入能够生成可用的图片输出），且不得引入新的必需用户配置步骤
- **FR-004**: 系统 MUST 在图片生成失败时提供可定位的错误信息（含失败场景标识与原因概述），并确保不会导致机器人进程整体崩溃
- **FR-005**: 系统 MUST 提供一组可在本地与 CI 重复执行的图片回归样例集，用于验证迁移前后的输出可用性与稳定性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在主分支的 CI 流水线中，依赖安装阶段在连续 20 次运行中成功率 ≥ 95%
- **SC-002**: 迁移完成后，CI 单次流水线总耗时相较迁移前不增加超过 10%（以同等触发条件下的 10 次运行均值对比）
- **SC-003**: 在预定义的图片回归样例集中，100% 样例能够生成“可打开的图片文件/消息内容”，且关键信息不缺失
- **SC-004**: 迁移发布后 14 天内，不出现因图片生成依赖导致的 P0/P1 级别事故（例如大面积生成失败或频繁崩溃）

## Assumptions

- 项目当前存在一个或多个“生成图片并发送/输出”的核心能力，且这些能力可以被抽象为可重复触发的回归样例
- CI 主要运行环境为 GitHub Actions，且当前主要失败点集中在依赖安装阶段（非业务测试阶段）

## Out of Scope

- 不在本需求内：新增图片功能、重做现有图片视觉设计、引入新的业务命令或对外接口变更
- 不在本需求内：对非图片相关依赖的全面升级（除非其为迁移所必需且能证明与 CI 失败直接相关）
